<?xml version="1.0" encoding="utf-8" ?>
<odoo>
    <!-- Report Custody Pivot view -->
    <record id="report_custody_view_pivot" model="ir.ui.view">
        <field name="name">report.custody.view.pivot</field>
        <field name="model">report.custody</field>
        <field name="arch" type="xml">
            <pivot string="Custody Analysis" display_quantity="true" disable_linking="True">
                <field name="name" type="row"/>
                <field name="approved_by_id" type="col"/>
                <!-- ⭐ NEW: Return Performance Analysis -->
                <field name="return_performance" type="col"/>
            </pivot>
        </field>
    </record>

    <!-- Report Custody List view -->
    <record id="report_custody_view_tree" model="ir.ui.view">
        <field name="name">report.custody.view.list</field>
        <field name="model">report.custody</field>
        <field name="arch" type="xml">
            <list string="Custody Analysis">
                <field name="name"/>
                <field name="date_request"/>
                <field name="employee_id"/>
                <field name="purpose"/>
                <field name="custody_property_id"/>

                <!-- ⭐ Approval columns -->
                <field name="approved_by_id"/>
                <field name="approved_date"/>

                <!-- ⭐ Return tracking columns -->
                <field name="return_type"/>
                <field name="return_date" string="Expected Return"/>
                <field name="actual_return_date" string="Actual Return"/>
                <field name="returned_by_id"/>

                <!-- ⭐ Performance analysis -->
                <field name="return_performance" widget="badge"
                       decoration-success="return_performance == 'on_time'"
                       decoration-info="return_performance == 'early'"
                       decoration-warning="return_performance == 'late'"
                       decoration-muted="return_performance == 'not_returned'"/>
                <field name="is_overdue"/>
                <field name="days_overdue"/>

                <field name="state" widget="badge"
                       decoration-success="state == 'approved'"
                       decoration-info="state == 'to_approve'"
                       decoration-muted="state == 'returned'"
                       decoration-danger="state == 'rejected'"/>
            </list>
        </field>
    </record>

    <!-- Report Custody Search view -->
    <record id="report_custody_view_search" model="ir.ui.view">
        <field name="name">report.custody.view.search</field>
        <field name="model">report.custody</field>
        <field name="arch" type="xml">
            <search string="Custody Analysis">
                <field name="name"/>
                <field name="employee_id"/>
                <field name="custody_property_id"/>
                <field name="approved_by_id"/>
                <field name="returned_by_id"/>
                <field name="state"/>
                <field name="return_type"/>
                <field name="date_request"/>
                <field name="return_date"/>
                <field name="actual_return_date"/>

                <!-- ⭐ NEW: Performance and Return Filters -->
                <filter string="📊 Returned Early" name="returned_early"
                        domain="[('return_performance', '=', 'early')]"/>
                <filter string="✅ Returned On Time" name="returned_on_time"
                        domain="[('return_performance', '=', 'on_time')]"/>
                <filter string="⚠️ Returned Late" name="returned_late"
                        domain="[('return_performance', '=', 'late')]"/>
                <filter string="❌ Not Yet Returned" name="not_returned"
                        domain="[('return_performance', '=', 'not_returned')]"/>

                <separator/>

                <filter string="🔄 Fixed Return Date" name="fixed_return_type"
                        domain="[('return_type', '=', 'date')]"/>
                <filter string="🔄 Flexible Return" name="flexible_return_type"
                        domain="[('return_type', '=', 'flexible')]"/>
                <filter string="🔄 Term End Return" name="term_end_return_type"
                        domain="[('return_type', '=', 'term_end')]"/>

                <separator/>

                <!-- ✅ FIXED: XML Syntax - ใช้ &lt; และ &gt; แทน < และ > -->
                <filter string="📅 Returned This Week" name="returned_this_week"
                        domain="[('actual_return_date', '&gt;=', (context_today() - datetime.timedelta(days=7)).strftime('%Y-%m-%d'))]"/>
                <filter string="📅 Returned This Month" name="returned_this_month"
                        domain="[('actual_return_date', '&gt;=', (context_today().replace(day=1)).strftime('%Y-%m-%d'))]"/>
                <filter string="📅 Due This Week" name="due_this_week"
                        domain="[('return_date', '&lt;=', (context_today() + datetime.timedelta(days=7)).strftime('%Y-%m-%d')), ('return_date', '&gt;=', context_today().strftime('%Y-%m-%d'))]"/>

                <separator/>

                <group expand="0" string="Group By">
                    <filter string="Status" name="status" domain="[]"
                            context="{'group_by':'state'}"/>
                    <filter string="Employee" name="employee" domain="[]"
                            context="{'group_by':'employee_id'}"/>
                    <filter string="Property" name="property" domain="[]"
                            context="{'group_by':'custody_property_id'}"/>

                    <!-- ⭐ NEW: Approval Analysis Grouping -->
                    <filter string="Approved By" name="approved_by" domain="[]"
                            context="{'group_by':'approved_by_id'}"/>
                    <filter string="Returned By" name="returned_by" domain="[]"
                            context="{'group_by':'returned_by_id'}"/>

                    <!-- ⭐ NEW: Performance Analysis Grouping -->
                    <filter string="Return Performance" name="return_performance" domain="[]"
                            context="{'group_by':'return_performance'}"/>
                    <filter string="Return Type" name="return_type_group" domain="[]"
                            context="{'group_by':'return_type'}"/>

                    <!-- ⭐ Date Analysis Grouping -->
                    <filter string="Request Date" name="request_date" domain="[]"
                            context="{'group_by':'date_request'}"/>
                    <filter string="Expected Return Date" name="expected_return_date" domain="[]"
                            context="{'group_by':'return_date'}"/>
                    <filter string="Actual Return Date" name="actual_return_date" domain="[]"
                            context="{'group_by':'actual_return_date'}"/>
                    <filter string="Approved Date" name="approved_date" domain="[]"
                            context="{'group_by':'approved_date'}"/>
                </group>
            </search>
        </field>
    </record>

    <!-- ⭐ NEW: Return Performance Dashboard -->
    <record id="report_custody_performance_view_pivot" model="ir.ui.view">
        <field name="name">report.custody.performance.pivot</field>
        <field name="model">report.custody</field>
        <field name="arch" type="xml">
            <pivot string="Return Performance Analysis" display_quantity="true">
                <field name="return_performance" type="row"/>
                <field name="return_type" type="col"/>
                <field name="days_overdue" type="measure"/>
            </pivot>
        </field>
    </record>

    <!-- ⭐ NEW: Approver Performance Dashboard -->
    <record id="report_custody_approver_view_pivot" model="ir.ui.view">
        <field name="name">report.custody.approver.pivot</field>
        <field name="model">report.custody</field>
        <field name="arch" type="xml">
            <pivot string="Approver Performance Analysis" display_quantity="true">
                <field name="approved_by_id" type="row"/>
                <field name="return_performance" type="col"/>
            </pivot>
        </field>
    </record>

    <!-- Main Analysis Action -->
    <record id="action_report_custody" model="ir.actions.act_window">
        <field name="name">Custody Analysis</field>
        <field name="res_model">report.custody</field>
        <field name="view_mode">pivot,list</field>
        <field name="search_view_id" ref="report_custody_view_search"/>
        <field name="help" type="html">
            <p class="oe_view_nocontent">
                This report allows you to analyse all Custody Requests with comprehensive return tracking.
            </p>
        </field>
    </record>

    <!-- ⭐ NEW: Return Performance Analysis Action -->
    <record id="action_report_custody_performance" model="ir.actions.act_window">
        <field name="name">📊 Return Performance Analysis</field>
        <field name="res_model">report.custody</field>
        <field name="view_mode">pivot,list</field>
        <field name="view_id" ref="report_custody_performance_view_pivot"/>
        <field name="context">{'search_default_return_performance': 1}</field>
        <field name="help" type="html">
            <p class="oe_view_nocontent">
                Analyze return performance: early, on-time, late, and overdue returns.
            </p>
        </field>
    </record>

    <!-- ⭐ NEW: Approver Performance Analysis Action -->
    <record id="action_report_custody_approver_performance" model="ir.actions.act_window">
        <field name="name">👥 Approver Performance Analysis</field>
        <field name="res_model">report.custody</field>
        <field name="view_mode">pivot,list</field>
        <field name="view_id" ref="report_custody_approver_view_pivot"/>
        <field name="context">{'search_default_approved_by': 1}</field>
        <field name="help" type="html">
            <p class="oe_view_nocontent">
                Analyze performance by approver and return success rates.
            </p>
        </field>
    </record>

    <!-- ===== MENU STRUCTURE FOR REPORTS - FIXED ===== -->
    <!-- Reports menus are now defined in hr_custody_views_actions.xml to prevent conflicts -->
    <!-- This ensures centralized menu management and avoids External ID issues -->

</odoo>