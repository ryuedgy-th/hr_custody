<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- üì∏ Enhanced ir.attachment view for custody photo management -->
    <record id="ir_attachment_custody_view_form" model="ir.ui.view">
        <field name="name">ir.attachment.custody.form</field>
        <field name="model">ir.attachment</field>
        <field name="inherit_id" ref="base.view_attachment_form"/>
        <field name="arch" type="xml">
            <!-- ‚úÖ FIXED: Add fields after res_name field instead of trying to find notebook -->
            <field name="res_name" position="after">
                <!-- Custody-specific fields -->
                <field name="custody_photo_type" 
                       invisible="res_model != 'hr.custody'"/>
                <field name="custody_timestamp" 
                       invisible="res_model != 'hr.custody'"/>
                <field name="custody_location" 
                       invisible="res_model != 'hr.custody'"/>
            </field>
            
            <field name="description" position="after">
                <field name="custody_notes" 
                       invisible="res_model != 'hr.custody'"
                       placeholder="Add notes about this photo..."/>
            </field>
            
            <!-- ‚úÖ FIXED: Add custody info at the end instead of inside notebook -->
            <sheet position="inside">
                <!-- Custody Information Group (only for custody attachments) -->
                <group string="üè¢ Custody Info" invisible="res_model != 'hr.custody'">
                    <group string="Related Custody">
                        <field name="custody_id" readonly="1"/>
                        <field name="custody_property_id" readonly="1"/>
                        <field name="custody_employee_id" readonly="1"/>
                    </group>
                    <group string="Photo Quality">
                        <field name="photo_width" readonly="1"/>
                        <field name="photo_height" readonly="1"/>
                        <field name="photo_size_mb" readonly="1"/>
                        <field name="quality_score" readonly="1" widget="progressbar"/>
                        <field name="is_high_quality" readonly="1"/>
                    </group>
                </group>
            </sheet>
        </field>
    </record>

    <!-- üì∏ Custody Photo Gallery View - WITH LIGHTBOX FUNCTIONALITY -->
    <record id="ir_attachment_custody_view_kanban" model="ir.ui.view">
        <field name="name">ir.attachment.custody.kanban</field>
        <field name="model">ir.attachment</field>
        <field name="arch" type="xml">
            <kanban class="o_attachment_kanban o_custody_photo_gallery" create="false" js_class="attachment_kanban">
                <field name="id"/>
                <field name="name"/>
                <field name="mimetype"/>
                <field name="type"/>
                <field name="url"/>
                <field name="res_model"/>
                <field name="res_id"/>
                <field name="custody_photo_type"/>
                <field name="custody_timestamp"/>
                <field name="custody_notes"/>
                <field name="photo_size_mb"/>
                <field name="quality_score"/>
                <field name="is_high_quality"/>
                <field name="datas"/>
                <field name="checksum"/>
                <templates>
                    <t t-name="kanban-box">
                        <div class="o_attachment_wrap oe_kanban_card">
                            <!-- üì∏ Main Photo Display with Lightbox -->
                            <div class="o_image_box" style="position: relative; cursor: pointer;">
                                <t t-if="record.mimetype.value and record.mimetype.value.startswith('image/')">
                                    <!-- Real Image Display -->
                                    <img class="o_image o_attachment_image" 
                                         t-att-src="'/web/image/' + record.id.value + '?unique=' + record.checksum.value" 
                                         style="width: 200px; height: 150px; object-fit: cover; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);"
                                         t-att-alt="record.name.value"
                                         t-att-title="record.name.value"
                                         data-toggle="lightbox"
                                         t-att-data-src="'/web/image/' + record.id.value"
                                         onclick="openPhotoLightbox(this)"/>
                                    
                                    <!-- Photo Overlay Info -->
                                    <div class="o_image_overlay" style="position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(transparent, rgba(0,0,0,0.7)); color: white; padding: 8px; border-radius: 0 0 8px 8px;">
                                        <div style="font-size: 12px; font-weight: bold;" t-esc="record.name.value"/>
                                    </div>
                                    
                                    <!-- Quality Badge -->
                                    <t t-if="record.is_high_quality.value">
                                        <span class="badge badge-success" style="position: absolute; top: 8px; right: 8px;">
                                            ‚úÖ HQ
                                        </span>
                                    </t>
                                    <t t-else="">
                                        <span class="badge badge-warning" style="position: absolute; top: 8px; right: 8px;">
                                            ‚ö†Ô∏è STD
                                        </span>
                                    </t>
                                </t>
                                <t t-else="">
                                    <!-- Non-Image File Display -->
                                    <div class="o_attachment_image" style="width: 200px; height: 150px; display: flex; align-items: center; justify-content: center; background: #f8f9fa; border: 2px dashed #dee2e6; border-radius: 8px;">
                                        <div class="text-center text-muted">
                                            <i class="fa fa-file fa-3x mb-2"/>
                                            <br/>
                                            <small t-esc="record.name.value"/>
                                        </div>
                                    </div>
                                </t>
                            </div>
                            
                            <!-- üìã Photo Information -->
                            <div class="o_attachment_info" style="padding: 12px;">
                                <!-- Photo Type Badge -->
                                <div class="mb-2">
                                    <t t-if="record.custody_photo_type.value == 'handover_overall'">
                                        <span class="badge badge-primary">üì∏ Handover Overall</span>
                                    </t>
                                    <t t-elif="record.custody_photo_type.value == 'handover_detail'">
                                        <span class="badge badge-info">üîç Handover Detail</span>
                                    </t>
                                    <t t-elif="record.custody_photo_type.value == 'handover_serial'">
                                        <span class="badge badge-secondary">üè∑Ô∏è Serial Number</span>
                                    </t>
                                    <t t-elif="record.custody_photo_type.value == 'return_overall'">
                                        <span class="badge badge-success">üì¶ Return Overall</span>
                                    </t>
                                    <t t-elif="record.custody_photo_type.value == 'return_detail'">
                                        <span class="badge badge-warning">üîç Return Detail</span>
                                    </t>
                                    <t t-elif="record.custody_photo_type.value == 'return_damage'">
                                        <span class="badge badge-danger">‚ö†Ô∏è Damage Report</span>
                                    </t>
                                    <t t-else="">
                                        <span class="badge badge-light">üìÑ Document</span>
                                    </t>
                                </div>
                                
                                <!-- Photo Details -->
                                <div class="o_attachment_details text-muted small">
                                    <t t-if="record.custody_timestamp.value">
                                        <div>üìÖ <field name="custody_timestamp" widget="datetime"/></div>
                                    </t>
                                    <div>üíæ <t t-esc="record.photo_size_mb.value"/> MB</div>
                                    <t t-if="record.quality_score.value">
                                        <div>üéØ Quality: <t t-esc="Math.round(record.quality_score.value)"/>%</div>
                                    </t>
                                </div>
                                
                                <!-- Notes -->
                                <t t-if="record.custody_notes.value">
                                    <div class="o_attachment_notes mt-2 p-2" style="background: #f8f9fa; border-radius: 4px; font-size: 12px;">
                                        <t t-esc="record.custody_notes.value"/>
                                    </div>
                                </t>
                                
                                <!-- Action Buttons -->
                                <div class="mt-2">
                                    <button class="btn btn-sm btn-outline-primary" 
                                            type="button" 
                                            t-att-onclick="'openPhotoLightbox(document.querySelector(\\'img[data-src=\\\\\\'/web/image/' + record.id.value + '\\\\\\']\\'))'">
                                        üîç View Full Size
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary ml-1" 
                                            type="button"
                                            t-att-onclick="'window.open(\\'/web/content/' + record.id.value + '?download=true\\', \\'_blank\\')'">
                                        üì• Download
                                    </button>
                                </div>
                            </div>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>

    <!-- üì∏ Custom CSS and JavaScript for Photo Gallery -->
    <template id="custody_photo_gallery_assets" name="Custody Photo Gallery Assets">
        <xpath expr="." position="inside">
            <style>
                /* Photo Gallery Styles */
                .o_custody_photo_gallery .oe_kanban_card {
                    margin: 10px;
                    padding: 0;
                    border-radius: 12px;
                    overflow: hidden;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                    transition: all 0.3s ease;
                    background: white;
                }
                
                .o_custody_photo_gallery .oe_kanban_card:hover {
                    transform: translateY(-2px);
                    box-shadow: 0 8px 20px rgba(0,0,0,0.15);
                }
                
                .o_custody_photo_gallery .o_image_overlay {
                    opacity: 0;
                    transition: opacity 0.3s ease;
                }
                
                .o_custody_photo_gallery .oe_kanban_card:hover .o_image_overlay {
                    opacity: 1;
                }
                
                /* Lightbox Styles */
                .photo-lightbox-overlay {
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.9);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 9999;
                    opacity: 0;
                    transition: opacity 0.3s ease;
                }
                
                .photo-lightbox-overlay.show {
                    opacity: 1;
                }
                
                .photo-lightbox-content {
                    max-width: 90%;
                    max-height: 90%;
                    position: relative;
                }
                
                .photo-lightbox-image {
                    max-width: 100%;
                    max-height: 100%;
                    border-radius: 8px;
                    box-shadow: 0 4px 20px rgba(255,255,255,0.1);
                }
                
                .photo-lightbox-close {
                    position: absolute;
                    top: -40px;
                    right: 0;
                    color: white;
                    font-size: 24px;
                    cursor: pointer;
                    background: rgba(0,0,0,0.5);
                    border-radius: 50%;
                    width: 35px;
                    height: 35px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    transition: background 0.3s ease;
                }
                
                .photo-lightbox-close:hover {
                    background: rgba(0,0,0,0.8);
                }
                
                .photo-lightbox-info {
                    position: absolute;
                    bottom: -60px;
                    left: 0;
                    right: 0;
                    color: white;
                    text-align: center;
                    background: rgba(0,0,0,0.5);
                    padding: 10px;
                    border-radius: 4px;
                }
            </style>
            
            <script type="text/javascript">
                // Lightbox Functionality
                function openPhotoLightbox(imgElement) {
                    if (!imgElement || !imgElement.getAttribute('data-src')) return;
                    
                    // Create lightbox overlay
                    const overlay = document.createElement('div');
                    overlay.className = 'photo-lightbox-overlay';
                    overlay.onclick = function(e) {
                        if (e.target === overlay) closeLightbox();
                    };
                    
                    // Create lightbox content
                    const content = document.createElement('div');
                    content.className = 'photo-lightbox-content';
                    
                    // Create full-size image
                    const fullImage = document.createElement('img');
                    fullImage.className = 'photo-lightbox-image';
                    fullImage.src = imgElement.getAttribute('data-src');
                    fullImage.alt = imgElement.alt || 'Photo';
                    
                    // Create close button
                    const closeBtn = document.createElement('div');
                    closeBtn.className = 'photo-lightbox-close';
                    closeBtn.innerHTML = '√ó';
                    closeBtn.onclick = closeLightbox;
                    
                    // Create info panel
                    const info = document.createElement('div');
                    info.className = 'photo-lightbox-info';
                    info.innerHTML = imgElement.alt || 'Custody Photo';
                    
                    // Assemble lightbox
                    content.appendChild(fullImage);
                    content.appendChild(closeBtn);
                    content.appendChild(info);
                    overlay.appendChild(content);
                    
                    // Add to page
                    document.body.appendChild(overlay);
                    
                    // Show with animation
                    setTimeout(() => overlay.classList.add('show'), 10);
                    
                    // Handle keyboard
                    document.addEventListener('keydown', handleLightboxKeydown);
                    
                    function closeLightbox() {
                        overlay.classList.remove('show');
                        setTimeout(() => {
                            if (overlay.parentNode) {
                                overlay.parentNode.removeChild(overlay);
                            }
                            document.removeEventListener('keydown', handleLightboxKeydown);
                        }, 300);
                    }
                    
                    function handleLightboxKeydown(e) {
                        if (e.key === 'Escape') {
                            closeLightbox();
                        }
                    }
                }
                
                // Initialize when DOM is ready
                document.addEventListener('DOMContentLoaded', function() {
                    console.log('üì∏ Custody Photo Gallery loaded with lightbox functionality');
                });
            </script>
        </xpath>
    </template>

    <!-- üì∏ Custody Photos List View - SIMPLIFIED (NO BULK ACTIONS) -->
    <record id="ir_attachment_custody_view_tree" model="ir.ui.view">
        <field name="name">ir.attachment.custody.list</field>
        <field name="model">ir.attachment</field>
        <field name="arch" type="xml">
            <list create="false" delete="true" edit="false">
                <field name="name"/>
                <field name="custody_photo_type" string="Photo Type"/>
                <field name="custody_timestamp" string="Timestamp"/>
                <field name="photo_size_mb" string="Size (MB)"/>
                <field name="quality_score" string="Quality %"/>
                <field name="is_high_quality" string="High Quality"/>
                <field name="custody_employee_id" string="Employee"/>
                <field name="custody_property_id" string="Property"/>
                <field name="custody_location" string="Location"/>
                <field name="custody_notes" string="Notes"/>
            </list>
        </field>
    </record>

    <!-- üì∏ Custody Photos Search View -->
    <record id="ir_attachment_custody_view_search" model="ir.ui.view">
        <field name="name">ir.attachment.custody.search</field>
        <field name="model">ir.attachment</field>
        <field name="arch" type="xml">
            <search string="Custody Photos">
                <field name="name"/>
                <field name="custody_employee_id"/>
                <field name="custody_property_id"/>
                <field name="custody_photo_type"/>
                <field name="custody_location"/>
                <field name="custody_notes"/>
                
                <!-- Photo Type Filters -->
                <filter string="üì∏ Handover Photos" name="handover_photos"
                        domain="[('custody_photo_type', 'in', ['handover_overall', 'handover_detail', 'handover_serial'])]"/>
                <filter string="üì¶ Return Photos" name="return_photos"
                        domain="[('custody_photo_type', 'in', ['return_overall', 'return_detail', 'return_damage'])]"/>
                <filter string="üîß Maintenance Photos" name="maintenance_photos"
                        domain="[('custody_photo_type', '=', 'maintenance')]"/>
                
                <separator/>
                
                <!-- Quality Filters -->
                <filter string="‚úÖ High Quality" name="high_quality"
                        domain="[('is_high_quality', '=', True)]"/>
                <filter string="‚ö†Ô∏è Standard Quality" name="standard_quality"
                        domain="[('is_high_quality', '=', False)]"/>
                        
                <separator/>
                
                <!-- Size Filters -->
                <filter string="üì¶ Large Files" name="large_files"
                        domain="[('photo_size_mb', '&gt;', 2)]"/>
                <filter string="üìÑ Small Files" name="small_files"
                        domain="[('photo_size_mb', '&lt;', 1)]"/>
                
                <separator/>
                
                <!-- Date Filters -->
                <filter string="üìÖ Today" name="today"
                        domain="[('custody_timestamp', '&gt;=', context_today())]"/>
                <filter string="üìÖ This Week" name="this_week"
                        domain="[('custody_timestamp', '&gt;=', (context_today() - datetime.timedelta(days=7)))]"/>
                
                <!-- Group By -->
                <group expand="0" string="Group By">
                    <filter string="üìä Photo Type" name="group_photo_type"
                            context="{'group_by': 'custody_photo_type'}"/>
                    <filter string="üë§ Employee" name="group_employee"
                            context="{'group_by': 'custody_employee_id'}"/>
                    <filter string="üè¢ Property" name="group_property"
                            context="{'group_by': 'custody_property_id'}"/>
                    <filter string="üìÖ Date" name="group_date"
                            context="{'group_by': 'custody_timestamp:day'}"/>
                    <filter string="üéØ Quality" name="group_quality"
                            context="{'group_by': 'is_high_quality'}"/>
                </group>
            </search>
        </field>
    </record>

    <!-- üì∏ Custody Photos Action -->
    <record id="ir_attachment_custody_action" model="ir.actions.act_window">
        <field name="name">üì∏ Custody Photos</field>
        <field name="res_model">ir.attachment</field>
        <field name="view_mode">kanban,list,form</field>
        <field name="domain">[('res_model', '=', 'hr.custody'), ('mimetype', 'like', 'image%')]</field>
        <field name="search_view_id" ref="ir_attachment_custody_view_search"/>
        <field name="context">{
            'default_res_model': 'hr.custody',
            'search_default_handover_photos': 1,
        }</field>
        <field name="help" type="html">
            <p class="oe_view_nocontent_create">
                üì∏ No custody photos found.
            </p>
            <p>
                Photos are automatically organized by type:
                ‚Ä¢ <strong>üì∏ Handover Photos</strong> - Taken when property is handed over<br/>
                ‚Ä¢ <strong>üì¶ Return Photos</strong> - Taken when property is returned<br/>
                ‚Ä¢ <strong>üîß Maintenance Photos</strong> - During maintenance or repairs
            </p>
            <p class="text-muted">
                <small>üí° Click on any photo to view in full size. Use the "üîç View Full Size" button or click directly on the image.</small>
            </p>
        </field>
    </record>

    <!-- üì∏ Add to menu -->
    <menuitem action="ir_attachment_custody_action"
              id="hr_custody_photos_menu"
              parent="hr_custody_menu_management"
              name="üì∏ Photo Gallery"
              sequence="3"
              groups="hr.group_hr_user,hr.group_hr_manager"/>

</odoo>