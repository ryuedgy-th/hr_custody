<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- üì∏ HR CUSTODY PHOTO MANAGEMENT SYSTEM - FIXED CONTEXT LINKING -->
    
    <!-- ===== ATTACHMENT MODEL EXTENSIONS ===== -->
    
    <!-- Add custody photo fields to ir.attachment -->
    <record id="ir_attachment_custody_extensions" model="ir.ui.view">
        <field name="name">ir.attachment.custody.extensions</field>
        <field name="model">ir.attachment</field>
        <field name="inherit_id" ref="base.view_attachment_form"/>
        <field name="arch" type="xml">
            <field name="name" position="after">
                <field name="custody_photo_type" 
                       invisible="res_model != 'hr.custody'"
                       groups="hr.group_hr_user,hr.group_hr_manager"/>
                <field name="custody_timestamp" 
                       invisible="res_model != 'hr.custody'"
                       groups="hr.group_hr_user,hr.group_hr_manager"/>
                <field name="custody_notes" 
                       invisible="res_model != 'hr.custody'"
                       groups="hr.group_hr_user,hr.group_hr_manager"/>
                <field name="quality_score" 
                       invisible="res_model != 'hr.custody'"
                       groups="hr.group_hr_user,hr.group_hr_manager"/>
                <field name="photo_size_mb" 
                       invisible="res_model != 'hr.custody'"
                       groups="hr.group_hr_user,hr.group_hr_manager"/>
                <field name="is_high_quality" 
                       invisible="res_model != 'hr.custody'"
                       groups="hr.group_hr_user,hr.group_hr_manager"/>
            </field>
        </field>
    </record>

    <!-- ===== SPECIALIZED KANBAN VIEW FOR CUSTODY PHOTOS ===== -->
    
    <!-- Professional Photo Gallery Kanban View -->
    <record id="ir_attachment_custody_view_kanban" model="ir.ui.view">
        <field name="name">ir.attachment.custody.kanban</field>
        <field name="model">ir.attachment</field>
        <field name="arch" type="xml">
            <kanban class="o_kanban_mobile" create="false" delete="true">
                <field name="name"/>
                <field name="mimetype"/>
                <field name="custody_photo_type"/>
                <field name="file_size"/>
                <field name="checksum"/>
                <field name="custody_timestamp"/>
                <field name="custody_notes"/>
                <field name="quality_score"/>
                <field name="photo_size_mb"/>
                <field name="is_high_quality"/>
                <templates>
                    <t t-name="kanban-box">
                        <div class="oe_kanban_card o_attachment_wrap" 
                             style="margin: 10px; padding: 10px; border-radius: 12px; 
                                    box-shadow: 0 4px 12px rgba(0,0,0,0.1); background: white;">
                            
                            <!-- Image Display Area -->
                            <div class="o_image_box" style="position: relative; text-align: center; margin-bottom: 10px;">
                                <t t-if="record.mimetype.value and record.mimetype.value.startsWith('image/')">
                                    <a t-attf-href="/web/image/#{record.id.raw_value}?field=datas" target="_blank" 
                                       style="display: block; position: relative;">
                                        <img class="o_image" 
                                             t-attf-src="/web/image/#{record.id.raw_value}?field=datas"
                                             style="width: 200px; height: 150px; object-fit: cover; 
                                                    border-radius: 8px; cursor: pointer;"
                                             t-att-alt="record.name.value"
                                             title="Click to view full size"
                                             loading="lazy"/>
                                        
                                        <!-- Quality Badge -->
                                        <t t-if="record.is_high_quality.value">
                                            <span class="badge badge-success" 
                                                  style="position: absolute; top: 5px; right: 5px; z-index: 2;">
                                                ‚úÖ HQ
                                            </span>
                                        </t>
                                        <t t-else="">
                                            <span class="badge badge-warning" 
                                                  style="position: absolute; top: 5px; right: 5px; z-index: 2;">
                                                ‚ö†Ô∏è STD
                                            </span>
                                        </t>
                                    </a>
                                </t>
                                <t t-else="">
                                    <div style="width: 200px; height: 150px; display: flex; 
                                                align-items: center; justify-content: center; 
                                                background: #f8f9fa; border: 2px dashed #dee2e6; 
                                                border-radius: 8px; margin: 0 auto;">
                                        <div class="text-center text-muted">
                                            <i class="fa fa-file fa-3x mb-2"/>
                                            <br/>
                                            <small><t t-esc="record.name.value"/></small>
                                        </div>
                                    </div>
                                </t>
                            </div>
                            
                            <!-- Photo Information -->
                            <div class="o_attachment_info">
                                <!-- File Name -->
                                <div style="font-weight: bold; margin-bottom: 8px; 
                                            overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"
                                     t-att-title="record.name.value">
                                    <t t-esc="record.name.value"/>
                                </div>
                                
                                <!-- Photo Type Badges -->
                                <div style="margin-bottom: 8px;">
                                    <t t-if="record.custody_photo_type.value == 'handover_overall'">
                                        <span class="badge badge-primary">üì∏ Handover Overall</span>
                                    </t>
                                    <t t-elif="record.custody_photo_type.value == 'handover_detail'">
                                        <span class="badge badge-info">üîç Handover Detail</span>
                                    </t>
                                    <t t-elif="record.custody_photo_type.value == 'handover_serial'">
                                        <span class="badge badge-secondary">üè∑Ô∏è Serial Number</span>
                                    </t>
                                    <t t-elif="record.custody_photo_type.value == 'return_overall'">
                                        <span class="badge badge-success">üì¶ Return Overall</span>
                                    </t>
                                    <t t-elif="record.custody_photo_type.value == 'return_detail'">
                                        <span class="badge badge-warning">üîç Return Detail</span>
                                    </t>
                                    <t t-elif="record.custody_photo_type.value == 'return_damage'">
                                        <span class="badge badge-danger">‚ö†Ô∏è Damage Report</span>
                                    </t>
                                    <t t-else="">
                                        <span class="badge badge-light">üìÑ Document</span>
                                    </t>
                                </div>
                                
                                <!-- Metadata -->
                                <div class="text-muted small" style="margin-bottom: 8px;">
                                    <t t-if="record.custody_timestamp.value">
                                        <div>üìÖ <field name="custody_timestamp" widget="datetime"/></div>
                                    </t>
                                    <div>üíæ <t t-esc="Math.round(record.photo_size_mb.value * 100) / 100"/> MB</div>
                                    <t t-if="record.quality_score.value">
                                        <div>üéØ Quality: <t t-esc="Math.round(record.quality_score.value)"/>%</div>
                                    </t>
                                </div>
                                
                                <!-- Notes -->
                                <t t-if="record.custody_notes.value">
                                    <div style="background: #f8f9fa; border-radius: 4px; padding: 6px; 
                                                font-size: 12px; margin-bottom: 8px; 
                                                max-height: 60px; overflow-y: auto;">
                                        <t t-esc="record.custody_notes.value"/>
                                    </div>
                                </t>
                                
                                <!-- Action Buttons -->
                                <div class="text-center">
                                    <a t-attf-href="/web/image/#{record.id.raw_value}?field=datas" 
                                       target="_blank"
                                       class="btn btn-sm btn-outline-primary" 
                                       style="margin-right: 5px;">
                                        üîç View Full Size
                                    </a>
                                    <a t-attf-href="/web/content/#{record.id.raw_value}?download=true" 
                                       target="_blank"
                                       class="btn btn-sm btn-outline-secondary">
                                        üì• Download
                                    </a>
                                </div>
                            </div>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>

    <!-- Custody Photos Tree/List View -->
    <record id="ir_attachment_custody_view_tree" model="ir.ui.view">
        <field name="name">ir.attachment.custody.tree</field>
        <field name="model">ir.attachment</field>
        <field name="arch" type="xml">
            <list create="false" delete="true" edit="false">
                <field name="name"/>
                <field name="custody_photo_type"/>
                <field name="mimetype"/>
                <field name="file_size" widget="float"/>
                <field name="custody_timestamp"/>
                <field name="quality_score"/>
                <field name="is_high_quality"/>
                <field name="custody_notes"/>
            </list>
        </field>
    </record>

    <!-- ===== MAIN FORM PHOTO TABS ===== -->
    
    <!-- Photo Tabs Extension for Main Form -->
    <record id="hr_custody_photo_tabs" model="ir.ui.view">
        <field name="name">hr.custody.photo.tabs</field>
        <field name="model">hr.custody</field>
        <field name="inherit_id" ref="hr_custody.hr_custody_view_form"/>
        <field name="arch" type="xml">
            <notebook position="inside">
                
                <!-- üì∏ Handover Photos Tab -->
                <page string="üì∏ Handover Photos" 
                      invisible="state not in ['approved', 'returned']">
                    
                    <!-- Photo Guidelines Banner -->
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                                color: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; 
                                box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                        <div class="row">
                            <div class="col-md-8">
                                <h4 style="margin: 0 0 12px 0; font-weight: 600;">üì∏ Handover Photo Guidelines</h4>
                                <div class="row" style="font-size: 13px; line-height: 1.6;">
                                    <div class="col-md-6">
                                        ‚Ä¢ Take overall photos showing complete item<br/>
                                        ‚Ä¢ Capture detailed photos of important features<br/>
                                        ‚Ä¢ Include serial number or identification tags
                                    </div>
                                    <div class="col-md-6">
                                        ‚Ä¢ Ensure good lighting and clarity<br/>
                                        ‚Ä¢ Maximum 5MB per photo<br/>
                                        ‚Ä¢ Multiple angles recommended
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 text-right">
                                <div style="font-size: 48px; opacity: 0.7;">üì∏</div>
                            </div>
                        </div>
                    </div>

                    <!-- Upload Section -->
                    <div style="background: #f8f9fa; border: 2px dashed #dee2e6; 
                                border-radius: 16px; padding: 24px; margin-bottom: 24px; 
                                transition: all 0.3s ease;">
                        <div class="text-center" style="margin-bottom: 20px;">
                            <div style="background: #007bff; color: white; width: 60px; height: 60px; 
                                        border-radius: 50%; display: inline-flex; align-items: center; 
                                        justify-content: center; margin-bottom: 12px; font-size: 24px;">üì∏</div>
                            <h4 style="color: #007bff; margin-bottom: 8px; font-weight: 600;">Upload Handover Photos</h4>
                            <p style="color: #6c757d; margin: 0;">Drag and drop photos here or click to browse</p>
                        </div>
                        
                        <!-- üîß TRIGGER AUTO-ASSIGNMENT: Add hidden field to track changes -->
                        <field name="id" invisible="1"/>
                        
                        <field name="handover_photo_ids" 
                               widget="many2many_binary"
                               string=""
                               nolabel="1"
                               options="{
                                   'accepted_file_extensions': 'image/*',
                                   'max_upload_size': 5242880
                               }"
                               readonly="state == 'returned'"
                               groups="hr.group_hr_user,hr.group_hr_manager"/>
                    </div>

                    <!-- Photo Gallery -->
                    <div invisible="not handover_photo_count">
                        <div style="display: flex; align-items: center; justify-content: space-between; 
                                    margin-bottom: 20px; padding-bottom: 12px; border-bottom: 2px solid #e9ecef;">
                            <h4 style="color: #007bff; margin: 0; font-weight: 600; display: flex; align-items: center;">
                                <span style="background: #007bff; color: white; width: 32px; height: 32px; 
                                             border-radius: 50%; display: inline-flex; align-items: center; 
                                             justify-content: center; margin-right: 12px; font-size: 16px;">üì∏</span>
                                Handover Photo Gallery
                            </h4>
                            <span style="background: #e3f2fd; color: #1976d2; padding: 6px 12px; 
                                         border-radius: 20px; font-size: 14px; font-weight: 500;">
                                <field name="handover_photo_count" nolabel="1"/> photos
                            </span>
                        </div>
                        
                        <field name="handover_photo_ids" 
                               mode="kanban"
                               nolabel="1"
                               kanban_view_ref="hr_custody.ir_attachment_custody_view_kanban"/>
                    </div>

                    <!-- Empty State -->
                    <div invisible="handover_photo_count" 
                         style="text-align: center; padding: 60px 20px; background: #f8f9fa; 
                                border-radius: 16px; border: 2px dashed #dee2e6;">
                        <div style="font-size: 64px; color: #dee2e6; margin-bottom: 20px;">üì∏</div>
                        <h4 style="color: #6c757d; margin-bottom: 12px;">No Handover Photos Yet</h4>
                        <p style="color: #adb5bd; margin: 0;">Upload photos using the area above to document the handover condition</p>
                    </div>
                </page>

                <!-- üì¶ Return Photos Tab -->
                <page string="üì¶ Return Photos" 
                      invisible="state != 'returned'">
                    
                    <!-- Guidelines Banner -->
                    <div style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); 
                                color: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; 
                                box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                        <div class="row">
                            <div class="col-md-8">
                                <h4 style="margin: 0 0 12px 0; font-weight: 600;">üì¶ Return Photo Guidelines</h4>
                                <div class="row" style="font-size: 13px; line-height: 1.6;">
                                    <div class="col-md-6">
                                        ‚Ä¢ Document the condition when returned<br/>
                                        ‚Ä¢ Show any damage or wear clearly<br/>
                                        ‚Ä¢ Compare with handover condition
                                    </div>
                                    <div class="col-md-6">
                                        ‚Ä¢ Include any missing accessories<br/>
                                        ‚Ä¢ Take photos from same angles as handover<br/>
                                        ‚Ä¢ Note any changes or issues
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 text-right">
                                <div style="font-size: 48px; opacity: 0.7;">üì¶</div>
                            </div>
                        </div>
                    </div>

                    <!-- Upload Section -->
                    <div style="background: #f8f9fa; border: 2px dashed #dee2e6; 
                                border-radius: 16px; padding: 24px; margin-bottom: 24px; 
                                transition: all 0.3s ease;">
                        <div class="text-center" style="margin-bottom: 20px;">
                            <div style="background: #28a745; color: white; width: 60px; height: 60px; 
                                        border-radius: 50%; display: inline-flex; align-items: center; 
                                        justify-content: center; margin-bottom: 12px; font-size: 24px;">üì¶</div>
                            <h4 style="color: #28a745; margin-bottom: 8px; font-weight: 600;">Upload Return Photos</h4>
                            <p style="color: #6c757d; margin: 0;">Drag and drop photos here or click to browse</p>
                        </div>
                        
                        <!-- üîß TRIGGER AUTO-ASSIGNMENT: Add hidden field to track changes -->
                        <field name="id" invisible="1"/>
                        
                        <field name="return_photo_ids" 
                               widget="many2many_binary"
                               string=""
                               nolabel="1"
                               options="{
                                   'accepted_file_extensions': 'image/*',
                                   'max_upload_size': 5242880
                               }"
                               groups="hr.group_hr_user,hr.group_hr_manager"/>
                    </div>

                    <!-- Return Photo Gallery -->
                    <div invisible="not return_photo_count">
                        <div style="display: flex; align-items: center; justify-content: space-between; 
                                    margin-bottom: 20px; padding-bottom: 12px; border-bottom: 2px solid #e9ecef;">
                            <h4 style="color: #28a745; margin: 0; font-weight: 600; display: flex; align-items: center;">
                                <span style="background: #28a745; color: white; width: 32px; height: 32px; 
                                             border-radius: 50%; display: inline-flex; align-items: center; 
                                             justify-content: center; margin-right: 12px; font-size: 16px;">üì¶</span>
                                Return Photo Gallery
                            </h4>
                            <span style="background: #e8f5e8; color: #2e7d32; padding: 6px 12px; 
                                         border-radius: 20px; font-size: 14px; font-weight: 500;">
                                <field name="return_photo_count" nolabel="1"/> photos
                            </span>
                        </div>
                        
                        <field name="return_photo_ids" 
                               mode="kanban"
                               nolabel="1"
                               kanban_view_ref="hr_custody.ir_attachment_custody_view_kanban"/>
                    </div>

                    <!-- Empty State -->
                    <div invisible="return_photo_count" 
                         style="text-align: center; padding: 60px 20px; background: #f8f9fa; 
                                border-radius: 16px; border: 2px dashed #dee2e6;">
                        <div style="font-size: 64px; color: #dee2e6; margin-bottom: 20px;">üì¶</div>
                        <h4 style="color: #6c757d; margin-bottom: 12px;">No Return Photos Yet</h4>
                        <p style="color: #adb5bd; margin: 0;">Upload photos using the area above to document the return condition</p>
                    </div>
                </page>

                <!-- üîç Photo Comparison Tab -->
                <page string="üîç Photo Comparison" 
                      invisible="state != 'returned' or not has_handover_photos or not has_return_photos">
                    
                    <!-- Comparison Header -->
                    <div style="background: linear-gradient(135deg, #6f42c1 0%, #e83e8c 100%); 
                                color: white; border-radius: 12px; padding: 20px; margin-bottom: 24px; 
                                box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                        <div class="row">
                            <div class="col-md-8">
                                <h4 style="margin: 0 0 8px 0; font-weight: 600;">üîç Photo Comparison Analysis</h4>
                                <p style="margin: 0; opacity: 0.9;">Compare handover vs return condition side by side</p>
                            </div>
                            <div class="col-md-4 text-right">
                                <div style="font-size: 48px; opacity: 0.7;">üîç</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); 
                                        border-radius: 12px; padding: 16px; margin-bottom: 16px;">
                                <h4 style="color: #1976d2; margin: 0; font-weight: 600;">üì∏ Handover Condition</h4>
                            </div>
                            <field name="handover_photo_ids" 
                                   mode="kanban"
                                   nolabel="1"
                                   kanban_view_ref="hr_custody.ir_attachment_custody_view_kanban"/>
                        </div>
                        <div class="col-md-6">
                            <div style="background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%); 
                                        border-radius: 12px; padding: 16px; margin-bottom: 16px;">
                                <h4 style="color: #2e7d32; margin: 0; font-weight: 600;">üì¶ Return Condition</h4>
                            </div>
                            <field name="return_photo_ids" 
                                   mode="kanban"
                                   nolabel="1"
                                   kanban_view_ref="hr_custody.ir_attachment_custody_view_kanban"/>
                        </div>
                    </div>

                    <!-- Documentation Summary -->
                    <div style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); 
                                border-radius: 12px; padding: 20px; margin-top: 24px;">
                        <h5 style="color: #495057; margin-bottom: 16px; font-weight: 600;">üìä Documentation Summary</h5>
                        <div class="row">
                            <div class="col-md-3">
                                <div style="text-align: center; padding: 12px;">
                                    <div style="font-size: 24px; font-weight: 700; color: #007bff;">
                                        <field name="handover_photo_count" nolabel="1"/>
                                    </div>
                                    <div style="font-size: 12px; color: #6c757d; text-transform: uppercase; letter-spacing: 1px;">
                                        Handover Photos
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div style="text-align: center; padding: 12px;">
                                    <div style="font-size: 24px; font-weight: 700; color: #28a745;">
                                        <field name="return_photo_count" nolabel="1"/>
                                    </div>
                                    <div style="font-size: 12px; color: #6c757d; text-transform: uppercase; letter-spacing: 1px;">
                                        Return Photos
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div style="text-align: center; padding: 12px;">
                                    <div style="font-size: 24px; font-weight: 700; color: #6f42c1;">
                                        <field name="total_photo_count" nolabel="1"/>
                                    </div>
                                    <div style="font-size: 12px; color: #6c757d; text-transform: uppercase; letter-spacing: 1px;">
                                        Total Photos
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div style="text-align: center; padding: 12px;">
                                    <div style="font-size: 20px;">
                                        <span style="color: #28a745;" invisible="not photos_complete">‚úÖ Complete</span>
                                        <span style="color: #ffc107;" invisible="photos_complete">‚ö†Ô∏è Incomplete</span>
                                    </div>
                                    <div style="font-size: 12px; color: #6c757d; text-transform: uppercase; letter-spacing: 1px;">
                                        Documentation
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </page>
            </notebook>
        </field>
    </record>

    <!-- Photo Comparison Popup View -->
    <record id="hr_custody_photo_comparison_view_form" model="ir.ui.view">
        <field name="name">hr.custody.photo.comparison.form</field>
        <field name="model">hr.custody</field>
        <field name="arch" type="xml">
            <form string="Photo Comparison" create="false" edit="false">
                <sheet>
                    <h2>üîç Photo Comparison: <field name="name" nolabel="1" readonly="1"/></h2>
                    <group>
                        <group>
                            <field name="employee_id" readonly="1"/>
                            <field name="custody_property_id" readonly="1"/>
                        </group>
                        <group>
                            <field name="approved_date" readonly="1"/>
                            <field name="actual_return_date" readonly="1"/>
                        </group>
                    </group>
                    
                    <div class="row mt16">
                        <div class="col-md-6">
                            <h3>üì∏ Handover Condition</h3>
                            <field name="handover_photo_ids" 
                                   mode="kanban"
                                   nolabel="1"
                                   kanban_view_ref="hr_custody.ir_attachment_custody_view_kanban"/>
                        </div>
                        <div class="col-md-6">
                            <h3>üì¶ Return Condition</h3>
                            <field name="return_photo_ids" 
                                   mode="kanban"
                                   nolabel="1"
                                   kanban_view_ref="hr_custody.ir_attachment_custody_view_kanban"/>
                        </div>
                    </div>
                </sheet>
            </form>
        </field>
    </record>
</odoo>